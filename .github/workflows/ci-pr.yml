name: CI - Pull Request

on:
  pull_request:
    branches: [develop, staging, main]

concurrency:
  group: ci-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      changed_services: ${{ steps.detect.outputs.changed_services }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        id: detect
        uses: ./.github/actions/detect-changes

  determine-version-suffix:
    runs-on: ubuntu-latest
    outputs:
      suffix: ${{ steps.suffix.outputs.suffix }}
      environment: ${{ steps.suffix.outputs.environment }}
    steps:
      - name: Determine version suffix
        id: suffix
        run: |
          TARGET_BRANCH="${{ github.base_ref }}"

          case "$TARGET_BRANCH" in
            develop)
              echo "suffix=beta.${{ github.run_number }}" >> $GITHUB_OUTPUT
              echo "environment=dev" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "suffix=rc.${{ github.run_number }}" >> $GITHUB_OUTPUT
              echo "environment=staging" >> $GITHUB_OUTPUT
              ;;
            main)
              echo "suffix=" >> $GITHUB_OUTPUT
              echo "environment=prod" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "suffix=dev.${{ github.run_number }}" >> $GITHUB_OUTPUT
              echo "environment=dev" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "### Version Strategy" >> $GITHUB_STEP_SUMMARY
          echo "- Target branch: $TARGET_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "- Version suffix: $(cat $GITHUB_OUTPUT | grep suffix | cut -d= -f2)" >> $GITHUB_STEP_SUMMARY

  build:
    needs: [detect-changes, determine-version-suffix]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    uses: ./.github/workflows/_build-service.yml
    with:
      service: ${{ matrix.service }}
      service-path: ${{ matrix.path }}
      build-type: ${{ matrix.build_type }}
      build-output: ${{ matrix.build_output || '' }}
      version-suffix: ${{ needs.determine-version-suffix.outputs.suffix }}
      push: ${{ matrix.deploy_type == 'kubernetes' && matrix.needs_build }}
      skip-build: ${{ !matrix.needs_build }}
    secrets: inherit

  validate-platform:
    needs: [detect-changes, build]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate platform compatibility
        run: |
          if [[ -f "scripts/validate-platform.sh" ]]; then
            chmod +x scripts/validate-platform.sh
            ./scripts/validate-platform.sh
          else
            echo "Platform validation script not found, skipping"
          fi

  validate-schema:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for schema changes
        id: schema-changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            schema:
              - 'infra/mysql/migrations/**'
              - 'infra/mysql/schema/**'

      - name: Validate schema matches migrations
        if: steps.schema-changes.outputs.schema == 'true'
        run: |
          chmod +x scripts/validate-schema.sh
          ./scripts/validate-schema.sh --ci

      - name: Skip message
        if: steps.schema-changes.outputs.schema != 'true'
        run: |
          echo "No schema changes detected, skipping validation"
          echo "### Schema Validation" >> $GITHUB_STEP_SUMMARY
          echo "Skipped - no changes to migrations or schema files" >> $GITHUB_STEP_SUMMARY

  summary:
    needs: [detect-changes, determine-version-suffix, build, validate-schema]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## PR Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Target branch: ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- Version suffix: ${{ needs.determine-version-suffix.outputs.suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ needs.determine-version-suffix.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Changed Services" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.detect-changes.outputs.has_changes }}" == "true" ]]; then
            echo "${{ needs.detect-changes.outputs.changed_services }}" | tr ' ' '\n' | while read svc; do
              echo "- $svc" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "No service changes detected" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo ":white_check_mark: All builds passed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build.result }}" == "skipped" ]]; then
            echo ":fast_forward: Build skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Build failed" >> $GITHUB_STEP_SUMMARY
          fi
